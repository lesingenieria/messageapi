<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin DevilChat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#0b0b0c;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px}
    input,button{padding:10px;border-radius:8px;border:1px solid #333;background:#151516;color:#eaeaea}
    button{background:#0d6efd;border:none;font-weight:700;cursor:pointer}
    h2,h3{margin:8px 0}
    .list{display:grid;gap:8px}
    .item{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:10px;border:1px solid #262626;border-radius:8px;background:#111113}
    .btn-green{background:#198754}
    .btn-red{background:#dc3545}
    .btn-pink{background:#d63384}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ModeraciÃ³n â€“ Chat del Diablo</h2>

    <section>
      <h3>Pregunta actual</h3>
      <div class="row">
        <input id="qtext" placeholder="Escribe la preguntaâ€¦" maxlength="240" />
        <button class="btn-pink" id="publish">Publicar</button>
      </div>
      <div style="margin-top:8px">
        <button id="toggle" class="btn-green">Activar</button>
        <span id="status" class="muted"></span>
      </div>
    </section>

    <hr style="border:none;border-top:1px solid #1e1e1e;margin:16px 0" />

    <section>
      <h3>ðŸ“© Pendientes</h3>
      <div id="pending" class="list"></div>
    </section>

    <section>
      <h3>âœ… Aprobados</h3>
      <div id="approved" class="list"></div>
    </section>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const API = "/devilchat/api";
    const $ = (id)=>document.getElementById(id);

    function row(text, rightHtml){
      const div = document.createElement("div");
      div.className = "item";
      const left = document.createElement("div");
      left.textContent = text;
      const right = document.createElement("div");
      right.innerHTML = rightHtml;
      div.appendChild(left); div.appendChild(right);
      return div;
    }

    async function loadStatus(){
      const s = await fetch(`${API}/devil/status`).then(r=>r.json());
      $("status").textContent = s?.active ? "Ronda ACTIVA" : "Ronda inactiva";
      $("toggle").textContent = s?.active ? "Desactivar" : "Activar";
    }

    async function publish(){
      const text = $("qtext").value.trim();
      if(!text){ alert("Escribe la pregunta"); return; }
      await fetch(`${API}/admin/question`,{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text })
      });
      $("qtext").value = "";
      await loadStatus();
      await refreshLists();
    }

    async function toggleActive(){
      const s = await fetch(`${API}/devil/status`).then(r=>r.json());
      const next = !(s?.active);
      await fetch(`${API}/admin/active`,{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ active: next })
      });
      await loadStatus();
    }

    async function refreshLists(){
      const [pending, approved] = await Promise.all([
        fetch(`${API}/admin/answers/pending`).then(r=>r.json()),
        fetch(`${API}/answers/approved`).then(r=>r.json()),
      ]);

      const p = $("pending"); p.innerHTML="";
      if(pending.length===0) p.innerHTML = '<div class="muted">Sin pendientes</div>';
      pending.forEach(m=>{
        const el = row(m.text, `
          <button class="btn-green" data-approve="${m.id}">Aprobar</button>
          <button class="btn-red" data-del="${m.id}">Eliminar</button>
        `);
        p.appendChild(el);
      });

      const a = $("approved"); a.innerHTML="";
      if(approved.length===0) a.innerHTML = '<div class="muted">Sin aprobados</div>';
      approved.slice().reverse().forEach(m=>{
        const el = row(m.text, `<button class="btn-red" data-del="${m.id}">Eliminar</button>`);
        a.appendChild(el);
      });
    }

    async function approve(id){
      await fetch(`${API}/admin/answers/${id}/approve`,{ method:"PUT" });
      await refreshLists();
    }
    async function remove(id){
      await fetch(`${API}/admin/answers/${id}`,{ method:"DELETE" });
      await refreshLists();
    }

    document.addEventListener("click",(e)=>{
      const a = e.target.getAttribute("data-approve");
      const d = e.target.getAttribute("data-del");
      if(a) approve(a);
      if(d) remove(d);
    });

    $("publish").onclick = publish;
    $("toggle").onclick = toggleActive;

    // Socket realtime
    const socket = io({ transports:["websocket"] });
    socket.on("devilchat:pending", refreshLists);
    socket.on("devilchat:new", refreshLists);
    socket.on("devilchat:newQuestion", async ()=>{
      await loadStatus();
      await refreshLists();
    });
    socket.on("devilchat:status", loadStatus);

    (async ()=>{
      await loadStatus();
      await refreshLists();
    })();
  </script>
</body>
</html>
