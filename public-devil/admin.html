<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin DevilChat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b0b0c;--panel:#111113;--border:#262626;--txt:#eaeaea;--muted:#9aa0a6;
           --btn:#0d6efd;--green:#198754;--red:#dc3545;--pink:#d63384}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px}
    input,button,textarea{padding:10px;border-radius:8px;border:1px solid var(--border);background:#151516;color:var(--txt)}
    button{background:var(--btn);border:none;font-weight:700;cursor:pointer}
    h2,h3{margin:8px 0}
    .list{display:grid;gap:8px}
    .item{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--panel)}
    .btn-green{background:var(--green)} .btn-red{background:var(--red)} .btn-pink{background:var(--pink)}
    .muted{color:var(--muted)}
    .tag{display:inline-block;font-size:12px;border:1px solid #7a1f1f;color:#ffbcbc;border-radius:999px;padding:2px 8px;font-weight:800;letter-spacing:.5px;background:#1a0e12; margin-bottom:8px}
    /* Auth modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .card{background:#141416;border:1px solid #2a2a2a;border-radius:12px;padding:16px;min-width:320px}
    .row-sm{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Moderaci√≥n ‚Äì Chat del Diablo</h2>

    <section>
      <span class="tag">EL DIABLO PREGUNTA‚Ä¶</span>
      <h3>Pregunta actual</h3>
      <div class="row">
        <input id="qtext" placeholder="Escribe la pregunta‚Ä¶" maxlength="240" />
        <button class="btn-pink" id="publish">Publicar</button>
      </div>
      <div style="margin-top:8px">
        <button id="toggle" class="btn-green">Activar</button>
        <span id="status" class="muted" style="margin-left:8px"></span>
      </div>
    </section>

    <hr style="border:none;border-top:1px solid #1e1e1e;margin:16px 0" />

    <section>
      <h3>üì© Pendientes</h3>
      <div id="pending" class="list"></div>
    </section>

    <section>
      <h3>‚úÖ Aprobados</h3>
      <div id="approved" class="list"></div>
    </section>
  </div>

  <!-- Modal Auth -->
  <div id="authModal" class="modal">
    <div class="card">
      <h3 style="margin-top:0">Acceso administrador</h3>
      <p class="muted" style="margin:6px 0 10px">Introduce la clave de administrador.</p>
      <div class="row-sm">
        <input id="adminKeyInput" type="password" placeholder="Clave admin" />
        <button id="saveKey">Entrar</button>
      </div>
      <div id="authErr" class="muted" style="color:#ff6b6b;margin-top:6px"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // ===== Config =====
    const API = "/devilchat/api";
    const LS_KEY = "devil_admin_key";
    const $ = (id)=>document.getElementById(id);

    // ===== Auth helper =====
    function getKey(){ return localStorage.getItem(LS_KEY) || ""; }
    function setKey(k){ localStorage.setItem(LS_KEY, k); }
    function showAuth(msg){
      if (msg) $("authErr").textContent = msg; else $("authErr").textContent = "";
      $("authModal").classList.add("show");
      $("adminKeyInput").focus();
    }
    function hideAuth(){ $("authModal").classList.remove("show"); }

    async function authFetch(url, opts={}){
      const key = getKey();
      const headers = new Headers(opts.headers || {});
      headers.set("x-admin-key", key);
      headers.set("Content-Type", "application/json");
      const res = await fetch(url, { ...opts, headers });
      if (res.status === 401){
        showAuth("Clave inv√°lida o ausente.");
        throw new Error("401 Unauthorized");
      }
      return res;
    }

    // ===== UI helpers =====
    function row(text, rightHtml){
      const div = document.createElement("div");
      div.className = "item";
      const left = document.createElement("div");
      left.textContent = text;
      const right = document.createElement("div");
      right.innerHTML = rightHtml;
      div.appendChild(left); div.appendChild(right);
      return div;
    }

    // ===== Data loaders =====
    async function loadStatus(){
      try{
        const s = await fetch(`${API}/devil/status`).then(r=>r.json()); // p√∫blica, sin clave
        const el = $("status"); if (!el) return;
        el.textContent = s?.active ? "Ronda ACTIVA" : "Ronda inactiva";
        const btn = $("toggle"); if (btn) btn.textContent = s?.active ? "Desactivar" : "Activar";
      }catch(e){ /* noop */ }
    }

    async function publish(){
      const text = $("qtext").value.trim();
      if(!text){ alert("Escribe la pregunta"); return; }
      await authFetch(`${API}/admin/question`,{
        method:"POST",
        body: JSON.stringify({ text })
      });
      $("qtext").value = "";
      await loadStatus();
      await refreshLists();
    }

    async function toggleActive(){
      // leer estado p√∫blico
      const s = await fetch(`${API}/devil/status`).then(r=>r.json());
      const next = !(s?.active);
      await authFetch(`${API}/admin/active`,{
        method:"POST",
        body: JSON.stringify({ active: next })
      });
      await loadStatus();
    }

    async function refreshLists(){
      try{
        const [pending, approved] = await Promise.all([
          authFetch(`${API}/admin/answers/pending`).then(r=>r.json()),
          fetch(`${API}/answers/approved`).then(r=>r.json()), // p√∫blica
        ]);

        const p = $("pending"); p.innerHTML="";
        if(pending.length===0) p.innerHTML = '<div class="muted">Sin pendientes</div>';
        pending.forEach(m=>{
          const el = row(m.text, `
            <button class="btn-green" data-approve="${m.id}">Aprobar</button>
            <button class="btn-pink" data-reply="${m.id}">Responder</button>
            <button class="btn-red" data-del="${m.id}">Eliminar</button>
            <div style="margin-top:6px; text-align:right">
              <button class="btn-green" data-reward="${m.id}" data-type="shot">üéØ Shot</button>
              <button class="btn-green" data-reward="${m.id}" data-type="drink">üçπ Copa</button>
            </div>
          `);
          p.appendChild(el);
        });

        const a = $("approved"); a.innerHTML="";
        if(approved.length===0) a.innerHTML = '<div class="muted">Sin aprobados</div>';
        approved.slice().reverse().forEach(m=>{
          const el = row(m.text, `
            <button class="btn-pink" data-reply="${m.id}">Responder</button>
            <button class="btn-red" data-del="${m.id}">Eliminar</button>
            <div style="margin-top:6px; text-align:right">
              <button class="btn-green" data-reward="${m.id}" data-type="shot">üéØ Shot</button>
              <button class="btn-green" data-reward="${m.id}" data-type="drink">üçπ Copa</button>
            </div>
          `);
          a.appendChild(el);
        });
      }catch(e){
        // Si es 401 ya se mostr√≥ modal, no romper
      }
    }

    async function approve(id){
      await authFetch(`${API}/admin/answers/${id}/approve`,{ method:"PUT" });
      await refreshLists();
    }
    async function removeMsg(id){
      await authFetch(`${API}/admin/answers/${id}`,{ method:"DELETE" });
      await refreshLists();
    }
    async function sendReply(id){
      const reply = prompt("Respuesta del Diablo:");
      if(!reply) return;
      await authFetch(`${API}/admin/answers/${id}/reply`,{
        method:"PUT", body: JSON.stringify({ reply })
      });
      await refreshLists();
    }
    async function rewardMsg(id, type){
      const code = prompt(`C√≥digo para el premio (${type}). D√©jalo vac√≠o para generar aleatorio:`, "");
      await authFetch(`${API}/admin/answers/${id}/reward`,{
        method:"PUT", body: JSON.stringify({ type, code: code || undefined })
      });
      await refreshLists();
      alert("Premio enviado al m√≥vil del usuario (si ten√≠a clientId) y marcado en pantalla.");
    }

    document.addEventListener("click",(e)=>{
      const a = e.target.getAttribute("data-approve");
      const d = e.target.getAttribute("data-del");
      const r = e.target.getAttribute("data-reply");
      const rw = e.target.getAttribute("data-reward");
      const rwt = e.target.getAttribute("data-type");
      if(a) approve(a);
      if(d) removeMsg(d);
      if(r) sendReply(r);
      if(rw) rewardMsg(rw, rwt || "shot");
    });

    $("publish").onclick = publish;
    $("toggle").onclick = toggleActive;

    // ===== Auth modal events =====
    $("saveKey").onclick = ()=>{
      const k = $("adminKeyInput").value.trim();
      if(!k){ $("authErr").textContent = "Introduce una clave v√°lida."; return; }
      setKey(k);
      hideAuth();
      bootstrap(); // reintentar
    };

    // ===== Socket realtime =====
    let socket;
    function connectSocket(){
      if (socket) try{ socket.disconnect(); }catch{}
      socket = io({ transports:["websocket"] });
      socket.on("connect", ()=>{
        const key = getKey();
        socket.emit("devilchat:admin:register", { key });
      });
      socket.on("devilchat:admin:error", (msg)=> showAuth(msg || "Clave inv√°lida"));
      socket.on("devilchat:pending", refreshLists);
      socket.on("devilchat:new", refreshLists);
      socket.on("devilchat:newQuestion", async ()=>{ await loadStatus(); await refreshLists(); });
      socket.on("devilchat:status", loadStatus);
    }

    async function bootstrap(){
      await loadStatus();
      await refreshLists();
      connectSocket();
    }

    // Inicio
    (async ()=>{
      if (!getKey()) showAuth();
      await bootstrap();
    })();
  </script>
</body>
</html>
