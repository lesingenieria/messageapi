<body>
  <div id="login" style="
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.85);z-index:9999">
    <div style="width:min(92vw,360px);background:#111113;border:1px solid #262626;border-radius:12px;padding:16px">
      <h3 style="margin:6px 0 12px 0">Acceso Admin</h3>
      <input id="admKey" type="password" placeholder="Clave de administrador"
             style="width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#151516;color:#eaeaea"/>
      <button id="btnLogin" style="margin-top:10px;width:100%;padding:12px;border-radius:8px;
              border:none;background:#0d6efd;color:#fff;font-weight:700;cursor:pointer">
        Entrar
      </button>
      <div id="loginErr" class="muted" style="color:#ff6b6b;margin-top:8px"></div>
    </div>
  </div>

  <div class="wrap"> <!-- tu panel tal cual debajo -->
    <!-- ... (tu HTML de admin existente) ... -->
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const API = "/devilchat/api";
    const $ = (id)=>document.getElementById(id);

    // ====== AUTH ======
    function getKey(){ return localStorage.getItem("DEVIL_ADMIN_KEY") || ""; }
    function setKey(k){ localStorage.setItem("DEVIL_ADMIN_KEY", k || ""); }
    function needLogin(show=true){ $("login").style.display = show ? "flex" : "none"; }

    async function tryKey(key){
      // probamos una ruta admin r치pida
      const ok = await fetch(`${API}/admin/questions`, { headers:{ "x-admin-key": key }})
        .then(r => r.ok).catch(()=>false);
      return ok;
    }

    $("btnLogin").onclick = async () => {
      const key = $("admKey").value.trim();
      $("loginErr").textContent = "";
      if(!key){ $("loginErr").textContent = "Introduce la clave"; return; }
      const ok = await tryKey(key);
      if(!ok){ $("loginErr").textContent = "Clave incorrecta"; return; }
      setKey(key); needLogin(false); bootstrap();
    };

    // ====== fetch helper con header ======
    async function aFetch(url, opts={}){
      const key = getKey();
      const headers = Object.assign({}, opts.headers || {}, { "x-admin-key": key });
      return fetch(url, Object.assign({}, opts, { headers }));
    }

    // === Sobrescribe TODAS las llamadas fetch del panel ===
    // Cambia:
    //   fetch(`${API}/admin/answers/pending`).then(...)
    // Por:
    //   aFetch(`${API}/admin/answers/pending`).then(...)

    // Ejemplos (sustituye en tu c칩digo):
    async function loadStatus(){
      const s = await aFetch(`${API}/devil/status`).then(r=>r.json());
      $("status").textContent = s?.active ? "Ronda ACTIVA" : "Ronda inactiva";
      $("toggle").textContent = s?.active ? "Desactivar" : "Activar";
    }
    async function publish(){
      const text = $("qtext").value.trim();
      if(!text){ alert("Escribe la pregunta"); return; }
      await aFetch(`${API}/admin/question`,{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text })
      });
      $("qtext").value = "";
      await loadStatus(); await refreshLists();
    }
    async function toggleActive(){
      const s = await aFetch(`${API}/devil/status`).then(r=>r.json());
      const next = !(s?.active);
      await aFetch(`${API}/admin/active`,{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ active: next })
      });
      await loadStatus();
    }
    async function refreshLists(){
      const [pending, approved] = await Promise.all([
        aFetch(`${API}/admin/answers/pending`).then(r=>r.json()),
        aFetch(`${API}/answers/approved`).then(r=>r.json()),
      ]);
      // ... (tu render)
    }
    async function approve(id){
      await aFetch(`${API}/admin/answers/${id}/approve`,{ method:"PUT" });
      await refreshLists();
    }
    async function removeMsg(id){
      await aFetch(`${API}/admin/answers/${id}`,{ method:"DELETE" });
      await refreshLists();
    }
    async function replyTo(id){
      const ta = document.querySelector(`[data-reply-text="${CSS.escape(id)}"]`);
      const reply = (ta?.value || "").trim();
      if(!reply){ alert("Escribe una respuesta"); return; }
      await aFetch(`${API}/admin/answers/${id}/reply`,{
        method:"PUT", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ reply })
      });
      ta.value = "";
      await refreshLists();
    }
    async function reward(id, kind){
      const { code } = await aFetch(`${API}/admin/answers/${id}/reward`,{
        method:"PUT", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ type: kind })
      }).then(r=>r.json());
      alert(`Premio enviado. C칩digo: ${code}`);
      await refreshLists();
    }

    // ====== Socket con registro admin ======
    let socket;
    function connectSocket(){
      socket = io({ transports:["websocket"] });
      socket.on("connect", ()=>{
        const key = getKey();
        socket.emit("devilchat:admin:register", { key });
      });
      socket.on("devilchat:admin:error", (msg)=>{ alert(msg); needLogin(true); });
      socket.on("devilchat:pending", refreshLists);
      socket.on("devilchat:new", refreshLists);
      socket.on("devilchat:newQuestion", async ()=>{ await loadStatus(); await refreshLists(); });
      socket.on("devilchat:status", loadStatus);
    }

    async function bootstrap(){
      await loadStatus(); await refreshLists(); connectSocket();
    }

    // Auto: si hay clave almacenada y es v치lida, entra directo
    (async ()=>{
      const stored = getKey();
      if(stored && await tryKey(stored)){ needLogin(false); bootstrap(); }
      else needLogin(true);
    })();
  </script>
</body>
