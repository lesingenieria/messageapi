<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Trafalgar 3</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ece5dd;
            color: black;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .chat-header {
            background-color: #075e54;
            padding: 15px;
            display: flex;
            align-items: center;
            color: white;
        }
        .chat-header div {
            background: black;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        .chat-header img {
            width: 40px;
            height: 40px;
        }
        .chat-header h2 {
            font-size: 1.2em;
            margin: 0;
        }
        .message {
            max-width: 70%;
            padding: 10px;
            border-radius: 10px;
            margin: 5px;
            font-size: 1em;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .sent {
            background-color: #dcf8c6;
            align-self: flex-end;
        }
        .received {
            background-color: #fff;
            align-self: flex-start;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #ccc;
        }
        .char-counter {
            font-size: 0.9em;
            color: gray;
            text-align: right;
            margin-bottom: 5px;
        }
        .cooldown-timer {
            font-size: 0.9em;
            color: red;
            text-align: center;
            margin-top: 5px;
        }
        .input-wrapper {
            display: flex;
        }
        .input-container input {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 1em;
            background-color: #f0f0f0;
            color: gray;
        }
        .input-container button {
            margin-left: 10px;
            background-color: #25d366;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            color: white;
        }
        .like-container {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }
        .like-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-right: 5px;
            color: red;
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <div>
            <img src="./trafalgarlogo.png" alt="Trafalgar 3">
        </div>
        <h2>Trafalgar 3</h2>
    </div>
    <div class="chat-container" id="chatContainer"></div>
    <div class="input-container">
        <span id="charCount" class="char-counter">50 caracteres restantes</span>
        <div class="input-wrapper">
            <input type="text" id="messageInput" maxlength="50" placeholder="Escribe un mensaje..." oninput="updateCharCount()">
            <button id="sendButton" onclick="sendMessage()">‚ñ∂</button>
        </div>
        <span id="cooldownTimer" class="cooldown-timer"></span>
    </div>

    <script>
        const API_URL = "/messages";
        const COOLDOWN_TIME = 5 * 60 * 1000; // 5 minutos en milisegundos

        function updateCharCount() {
            const text = document.getElementById("messageInput").value;
            const remaining = 50 - text.length;
            document.getElementById("charCount").textContent = remaining + " caracteres restantes";
        }

        function canSendMessage() {
            const lastSent = localStorage.getItem("lastMessageTime");
            if (!lastSent) return true;
            const elapsed = Date.now() - parseInt(lastSent);
            return elapsed > COOLDOWN_TIME;
        }

        function updateSendButton() {
            const sendButton = document.getElementById("sendButton");
            const messageInput = document.getElementById("messageInput");
            const cooldownTimer = document.getElementById("cooldownTimer");

            if (!canSendMessage()) {
                const remainingTime = Math.ceil((COOLDOWN_TIME - (Date.now() - parseInt(localStorage.getItem("lastMessageTime")))) / 1000);
                messageInput.disabled = true;
                sendButton.disabled = true;
                sendButton.textContent = "‚è≥";
                cooldownTimer.textContent = `Debes esperar ${Math.floor(remainingTime / 60)}m ${remainingTime % 60}s`;

                setTimeout(updateSendButton, 1000);
            } else {
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendButton.textContent = "‚ñ∂";
                cooldownTimer.textContent = "";
            }
        }

        function appendMessage(message) {
    const chatContainer = document.getElementById("chatContainer");
    const messageElement = document.createElement("div");
    messageElement.classList.add("message", message.sent ? "sent" : "received");
    messageElement.textContent = message.text;

    // Contenedor de Like
    const likeContainer = document.createElement("div");
    likeContainer.classList.add("like-container");

    const likeButton = document.createElement("button");
    likeButton.classList.add("like-button");

    // Cargar estado del like desde localStorage
    const likedMessages = JSON.parse(localStorage.getItem("likedMessages")) || {};
    likeButton.innerHTML = likedMessages[message.id] ? "‚ù§Ô∏è" : "ü§ç";

    const likeCount = document.createElement("span");
    likeCount.textContent = message.likes || 0;

    likeButton.onclick = () => toggleLike(message.id, likeButton, likeCount);

    likeContainer.appendChild(likeButton);
    likeContainer.appendChild(likeCount);
    messageElement.appendChild(likeContainer);

    chatContainer.appendChild(messageElement);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}


        function toggleLike(id, button, countSpan) {
    const likedMessages = JSON.parse(localStorage.getItem("likedMessages")) || {};
    const isLiked = likedMessages[id]; // Verifica si ya tiene like
    const url = `${API_URL}/${id}/${isLiked ? "unlike" : "like"}`;

    fetch(url, { method: "PUT" })
        .then(response => response.json())
        .then(data => {
            if (isLiked) {
                delete likedMessages[id]; // Eliminar el like del localStorage
                button.innerHTML = "ü§ç";
            } else {
                likedMessages[id] = true; // Guardar que este mensaje fue likeado
                button.innerHTML = "‚ù§Ô∏è";
            }

            localStorage.setItem("likedMessages", JSON.stringify(likedMessages));
            countSpan.textContent = data.likes;
        })
        .catch(err => console.error("Error:", err));
}


        
        function sendMessage() {
            if (!canSendMessage()) {
                alert("Debes esperar antes de enviar otro mensaje.");
                return;
            }

            const input = document.getElementById("messageInput");
            const text = input.value.trim();
            if (!text) {
                alert("Escribe un mensaje antes de enviarlo.");
                return;
            }

            fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            })
            .then(response => response.json())
            .then(data => {
                appendMessage(data.id, text, "sent", 0);
                input.value = "";
                updateCharCount();
                localStorage.setItem("lastMessageTime", Date.now());
                updateSendButton();
            })
            .catch(err => console.error("Error:", err));
        }

        function loadMessages(autoRefresh = false) {
    fetch(API_URL)
        .then(response => response.json())
        .then(messages => {
            const chatContainer = document.getElementById("chatContainer");
            chatContainer.innerHTML = ""; // Limpiar mensajes previos para evitar duplicados

            messages.reverse().forEach(msg => appendMessage(msg));

            if (!autoRefresh) {
                updateSendButton();
            }
        })
        .catch(err => console.error("Error al cargar mensajes:", err));
}

// Llamar a `loadMessages()` cada 5 segundos para actualizar el chat autom√°ticamente
setInterval(() => loadMessages(true), 5000);

// Cargar los mensajes inicialmente cuando la p√°gina se abre
window.onload = loadMessages;

    </script>
</body>
</html>
